{
  "meta": {
    "project": "Prompt Improver (DSPy) - Raycast Extension",
    "date": "2026-02-15",
    "prepared_by": "Generated by TestSprite"
  },
  "product_overview": "A FastAPI backend + Raycast extension that transforms raw ideas into production-ready prompts using DSPy few-shot learning and multiple LLM providers, while tracking multi-dimensional metrics and degrading gracefully when optional services fail.",
  "core_goals": [
    "Convert informal user ideas into structured, production-ready prompts with confidence scoring and guardrails.",
    "Support multiple LLM providers (Anthropic, DeepSeek, OpenAI, Gemini, Ollama) with provider selection and fallback behavior.",
    "Provide a metrics framework (quality, performance, impact, improvement) with summary, trend, and comparison APIs to monitor prompt quality over time.",
    "Ensure resilience via circuit breaker and graceful degradation (degradation_flags) when optional systems (LLM provider, SQLite) are unavailable.",
    "Expose health and root info endpoints for observability and developer workflows, and keep strict error mapping for predictable client behavior."
  ],
  "features": [
    {
      "name": "Prompt Improvement API",
      "description": "Improve a raw idea into a structured, production-ready prompt using DSPy + selected LLM provider; returns improved prompt, confidence, quality gate data, and degradation flags.",
      "user_flows": [
        "POST /api/v1/improve-prompt with body {\"idea\":\"write a python function to validate email addresses\",\"context\":\"backend utility\",\"guardrails\":[\"no external deps\"]} -> Receive 200 with {\"improved_prompt\": \"...\", \"confidence\": 0.86, \"quality_gate\": {...}, \"degradation_flags\": [...] }",
        "POST /api/v1/improve-prompt with body {\"idea\":\"\",\"context\":\"optional\"} -> Receive 400 with {\"error\":\"Invalid input\",\"detail\":\"idea must be a non-empty string\"}",
        "POST /api/v1/improve-prompt with body {\"idea\":\"generate marketing copy\",\"guardrails\":[] } -> Receive 503 with {\"error\":\"service_unavailable\",\"message\":\"LLM provider not configured or circuit breaker open\"} -> Receive degradation_flags indicating provider_unavailable or complex_strategy_disabled"
      ]
    },
    {
      "name": "Health Check",
      "description": "Check server health and DSPy/LLM provider configuration to surface readiness and configuration issues.",
      "user_flows": [
        "GET /health -> Receive 200 with {\"status\":\"healthy\",\"provider\":\"anthropic\",\"model\":\"claude-haiku-4-5-20251001\",\"dspy_configured\":true}",
        "GET /health -> Receive 200 with {\"status\":\"degraded\",\"provider\":null,\"model\":null,\"dspy_configured\":false} (indicates missing API key or not configured for selected provider)",
        "GET /health -> Receive 503 with {\"error\":\"service_unavailable\",\"message\":\"server failed to start or dependencies unavailable\"}"
      ]
    },
    {
      "name": "Metrics Summary",
      "description": "Retrieve aggregate metrics across all prompt improvements (total prompts, average quality/performance/impact, grade distribution).",
      "user_flows": [
        "GET /api/v1/metrics/summary -> Receive 200 with {\"total_prompts\":123,\"average_quality\":0.82,\"average_performance\":0.75,\"average_impact\":0.85,\"grade_distribution\":{...}}",
        "GET /api/v1/metrics/summary -> Receive 503 with {\"error\":\"metrics_unavailable\",\"message\":\"SQLite persistence not configured or database missing\"}"
      ]
    },
    {
      "name": "Metrics Trends",
      "description": "Return time-based trend analysis for metrics (periods and trends) to observe changes over days/weeks.",
      "user_flows": [
        "GET /api/v1/metrics/trends?days=30 -> Receive 200 with {\"periods\":[\"2026-01-17\",...],\"trends\":{\"quality\":[...],\"performance\":[...]}}",
        "GET /api/v1/metrics/trends?days=-7 -> Receive 400 with {\"error\":\"invalid_parameter\",\"detail\":\"days must be a positive integer\"}"
      ]
    },
    {
      "name": "Metrics Comparison",
      "description": "Compare metrics between two strategies or prompt sets (A/B) and return a structured comparison and winner.",
      "user_flows": [
        "GET /api/v1/metrics/compare?strategy_a=knn_example_selection&strategy_b=random_selection -> Receive 200 with {\"comparison\":[{\"metric\":\"quality\",\"a\":0.81,\"b\":0.72},...],\"winner\":\"knn_example_selection\"}",
        "GET /api/v1/metrics/compare?strategy_a=nonexistent&strategy_b=knn -> Receive 400 with {\"error\":\"strategy_not_found\",\"detail\":\"strategy_a not found in registry\"}"
      ]
    },
    {
      "name": "Root Info",
      "description": "Provide API information and a listing of available endpoints for clients and developer tools.",
      "user_flows": [
        "GET / -> Receive 200 with {\"message\":\"Prompt Improver API\",\"version\":\"<semver>\",\"endpoints\":{\"/api/v1/improve-prompt\":\"POST\",\"/api/v1/metrics/summary\":\"GET\",...}}",
        "GET / -> Receive 500 with {\"error\":\"internal_server_error\",\"message\":\"failed to build endpoints listing\"}"
      ]
    }
  ],
  "code_summary": {
    "version": "2",
    "type": "backend",
    "tech_stack": [
      "Python 3.10+",
      "FastAPI",
      "DSPy AI",
      "Pydantic v2",
      "SQLite (aiosqlite)",
      "LiteLLM (multi-provider support)",
      "uvicorn"
    ],
    "features": [
      {
        "name": "Prompt Improvement API",
        "description": "Core feature for improving raw ideas into structured prompts using DSPy",
        "files": [
          "api/prompt_improver_api.py",
          "eval/src/dspy_prompt_improver.py",
          "api/quality_gates.py"
        ],
        "endpoints": [
          {
            "method": "POST",
            "path": "/api/v1/improve-prompt",
            "description": "Improve a raw prompt idea into structured format",
            "auth_required": false,
            "request_schema": {
              "body": {
                "idea": "string",
                "context": "string (optional)",
                "guardrails": "string | array (optional)"
              }
            },
            "response_schema": {
              "200": {
                "improved_prompt": "string",
                "confidence": "number",
                "quality_gate": "object",
                "degradation_flags": "array"
              },
              "400": {
                "error": "string",
                "detail": "string"
              },
              "503": {
                "error": "string",
                "message": "string"
              }
            }
          }
        ],
        "depends_on": [
          "DSPy Configuration",
          "LLM Provider"
        ]
      },
      {
        "name": "Health Check",
        "description": "API health and configuration status",
        "files": [
          "api/main.py"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/health",
            "description": "Check server health and configuration",
            "auth_required": false,
            "response_schema": {
              "200": {
                "status": "string",
                "provider": "string",
                "model": "string",
                "dspy_configured": "boolean"
              }
            }
          }
        ],
        "depends_on": []
      },
      {
        "name": "Metrics Summary",
        "description": "Aggregate metrics statistics across all prompts",
        "files": [
          "api/metrics_api.py",
          "hemdov/domain/metrics/analyzers.py"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/v1/metrics/summary",
            "description": "Get overall metrics summary",
            "auth_required": false,
            "response_schema": {
              "200": {
                "total_prompts": "integer",
                "average_quality": "number",
                "average_performance": "number",
                "average_impact": "number",
                "grade_distribution": "object"
              }
            }
          }
        ],
        "depends_on": [
          "SQLite Metrics Repository"
        ]
      },
      {
        "name": "Metrics Trends",
        "description": "Time-based trend analysis",
        "files": [
          "api/metrics_api.py"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/v1/metrics/trends",
            "description": "Get trend analysis over time periods",
            "auth_required": false,
            "response_schema": {
              "200": {
                "periods": "array",
                "trends": "object"
              }
            }
          }
        ],
        "depends_on": [
          "Metrics Summary"
        ]
      },
      {
        "name": "Metrics Comparison",
        "description": "A/B testing comparison between strategies",
        "files": [
          "api/metrics_api.py"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/api/v1/metrics/compare",
            "description": "Compare metrics between different strategies",
            "auth_required": false,
            "response_schema": {
              "200": {
                "comparison": "array",
                "winner": "string"
              }
            }
          }
        ],
        "depends_on": [
          "Metrics Summary"
        ]
      },
      {
        "name": "Root Info",
        "description": "API information and endpoint listing",
        "files": [
          "api/main.py"
        ],
        "endpoints": [
          {
            "method": "GET",
            "path": "/",
            "description": "Get API information and available endpoints",
            "auth_required": false,
            "response_schema": {
              "200": {
                "message": "string",
                "version": "string",
                "endpoints": "object"
              }
            }
          }
        ],
        "depends_on": []
      }
    ],
    "known_limitations": [
      {
        "issue": "Requires LLM provider API key (Anthropic, OpenAI, Gemini, DeepSeek, or Ollama)",
        "location": "api/main.py",
        "impact": "Server fails to start without valid API key configuration"
      },
      {
        "issue": "SQLite database required for metrics persistence",
        "location": "hemdov/infrastructure/persistence/",
        "impact": "Metrics features unavailable without database"
      },
      {
        "issue": "Circuit breaker may block requests after failures",
        "location": "api/circuit_breaker.py",
        "impact": "API may return 503 after repeated failures"
      }
    ]
  }
}
